---
layout: post
title:  Kubernetes setting
data:   2020-09-16
author: ehtltnv
categories: [Docker]
tags: [docker, kubernetes]
---

__Kubernetes__ 환경 구축 테스트

OS는 `CentOS 7`에 구성은 `1 Master`와 `2 Node`로 구성 

Master는 4 Core / 8 RAM, Node는 각각 2 Core / 4 RAM

# 1. 기본 설정 

## 1.1. hostname 설정 

- 각 서버는 서로 다른 hostname을 가지고 있어야함 

```
<!-- Master -- > 
$ hostnamectl set-hostname k8s-m 

<!-- Node 1 -- > 
$ hostnamectl set-hostname k8s-n1 

<!-- Node 2 -- > 
$ hostnamectl set-hostname k8s-n2 
```

## 1.2. uuid / MAC Address 확인

- 각 서버는 서로 다른 uuid와 MAC Address를 가지고 있어햐함 
- 일반적으로 겹칠 가능성은 희박하나 혹시 모를 상황에 대비하여 확인 

```
<!-- uuid --> 
$ cat /sys/class/dmi/id/product_uuid  

<!-- MAC Address --> 
$ ip a 

```

## 1.3. SELinux 해제

- 해제(disable) 또는 permissive으로 설정 

```
$ vi /etc/sysconfig/selinux
7 SELINUX=disabled
```

## 1.4. 방화벽 해제 

- 포트를 파악해서 일일이 여는 방법도 있지만 .. 일단은 해제

```
$ systemctl stop firewalld && systemctl disable firewalld
```

## 1.5. iptables 설정 추가

- bridge 네트워크가 iptables를 우회하지 않도록 설정

```
$ cat <<EOF > /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
$ sysctl --system
```

## 1.6. host 맵핑

```
$ vi /etc/hosts
...
192.168.10.89   k8s-m
192.168.10.90   k8s-n1
192.168.10.91   k8s-n2
```

## 1.7. SWAP 비활성화

- swap 메모리를 비활성화해야 오류가 발생하지 않음

```
$ swapoff -a

<!-- 주석 처리 -->
$ vi /etc/fstab 
13 # /dev/mapper/centos-swap swap                    swap    defaults        0 0
```

## 1.8. 재시작

- 1.1. ~ 1.7. 까지 작업을 모든 서버(Master + Node1, 2)에 적용 후 재시작

--- 

# 2. Docker 설정

- Master / Node 모두 설정 

## 2.1. Docker 설치

```
$ yum install -y yum-utils device-mapper-persistent-data lvm2
$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
$ yum install -y docker-ce
```

## 2.2. Docker cgroup driver 변경 

- 최신 버전의 Docker와 Kubernetes를 사용할 경우 드라이버를 systemd로 설정하지 않으면 Master/Node가 연결 안됨

```
$ vi /lib/systemd/system/docker.service
14 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd
```

## 2.3. Docker 실행 

```
<!-- systemctl enable docker && systemctl start docker --> 
$ systemctl enable --now docker 

<!-- 실행 확인 --> 
$ docker version 

<!-- cgroup driver 확인 중요 !!-->
$ docker info | grep -i cgroup 
 Cgroup Driver: systemd 
```

---

# 3. Kubernetes 설정 

## 3.1. Kubernetes 설치

```
<!-- Repository 추가 -->
$ cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF

$ yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

<!-- 여기서는 실행 안되는게 정상 !! -->
$ systemctl enable --now kubelet
```

- 현 시점에서 kubelet의 서비스 상태는 fail이 맞음~~(아무도 말을 안해줘서 오류인줄 ..)~~
- 초기화 후에 정상 동작하므로 이후 프로세스 진행

## 3.2. Master 설정 

```
<!-- kubernetes 설정을 위한 이미지 다운로드. 미리 안해도 kubeadm init 때 다운로드함 -->
$ kubeadm config images pull

<!-- 
설정 초기화 
--pod-network-cidr : 10.244.0.0/16(Flannel)
--apiserver-advertise-address : Master IP

kubeadm join ~ 부분 복사
이후에 Node에 설정할 때 사용 
-->
$ kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.10.89
...
kubeadm join 192.168.10.89:6443 --token pv0ekh.odw4qk6lqnz2q9ss --discovery-token-ca-cert-hash sha256:225a464d125c94fa9543cf78e27c0c13ca68ab80328b7c1dfae9c707777265a9 
...

<!-- kubernetes 설정 -->
$ export KUBECONFIG=/etc/kubernetes/admin.conf

<!-- kubernetes network 플러그인 추가 -->
$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

<!-- cluster 초기 pod 확인 -->
$ kubectl get pods --all-namespaces

<!-- 설정을 잘못했을 경우 초기화 -->
$ kubeadm reset
```

## 3.3. Node 연결  

```
$ kubeadm join 192.168.10.89:6443 --token pv0ekh.odw4qk6lqnz2q9ss --discovery-token-ca-cert-hash sha256:225a464d125c94fa9543cf78e27c0c13ca68ab80328b7c1dfae9c707777265a9 
```

## 3.4. 연결 확인

- Master 에서 조회

```
<!-- 오류가 발생하면 'export KUBECONFIG=/etc/kubernetes/admin.conf' 실행 후 다시 실행-->
$ kubectl get nodes
NAME     STATUS     ROLES    AGE     VERSION
k8s-m    Ready      master   3h14m   v1.19.1
k8s-n1   Ready      <none>   3h9m    v1.19.1
k8s-n2   Ready      <none>   3h7m    v1.19.1
```

- STATUS가 Ready로 바뀌려면 시간이 좀 걸림

## 3.5. Master Token 조회 및 생성 

- 최초 init할 때 값을 잃어버렸을 경우 사용

```
<!-- EXPIRES 기간이 유효한지 확인 -->
$ kubeadm token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
pv0ekh.odw4qk6lqnz2q9ss   20h         2020-09-17T10:36:51+09:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token

<!-- 토큰이 만료 되었을 경우 새로 생성 -->
$ kubeadm token create
f0y6yi.sg2aw57af35nz0ek

$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
225a464d125c94fa9543cf78e27c0c13ca68ab80328b7c1dfae9c707777265a9
```

# 정리
- 초기 설정만 정의
- Volumn 및 서비스 형태 검토 필요
- 이제 Docker랑 잘 연결만 하면 ..

